---
postgres_manifests_dir: /etc/k8s/manifests/postgres

postgres:
  name: postgres
  replicas: 1
  type: NodePort

postgres_labels:
  k8s-app: postgres
  version: v1
  kubernetes.io/cluster-service: "true"

postgres_volumes:
    - name: varlibpostgres
      hostPath: 
        path: /var/lib/postgres/data
    - name: postgres-config
      secret:
        secretName: "postgres-config"

postgres_selector:
  k8s-app: postgres

postgres_container_image:
  name: quay.io/arkena/k8s-postgres
  tag: latest

postgres_container_env:
  - name: "POSTGRES_PASSWORD"
    value: "{{ pg_pass }}"

postgres_container_ports:
  - containerPort: 5432

postgres_container_volumemounts:
  - name: varlibpostgres
    mountPath: /var/lib/postgresql/data
  - name: postgres-config
    mountPath: "/etc/secrets"
    readOnly: true

# Container limits
postgres_container_limits:
  cpu: 800m
  # Note : to make things easier use the same unit as postgresql.conf (e.g. G, M, K etc...)
  memory: 2G

postgres_config:
  default_statistics_target : 100
  maintenance_work_mem : 64MB
  checkpoint_completion_target : 0.5
  effective_cache_size : 1GB # Must be lower than container limits
  work_mem : 4MB
  wal_buffers : -1
  checkpoint_segments : 3
  shared_buffers : 128MB

postgres_secrets:
  name: "postgres-config"
  type: "Opaque"
  data:
    password: "{{ pg_pass | b64encode }}"
    postgresql.conf: "{{ lookup('template',role_path+'/templates/config/postgresql.conf') | b64encode }}"
    pghba.conf: "{{ lookup('template',role_path+'/templates/config/pg_hba.conf') | b64encode }}"
